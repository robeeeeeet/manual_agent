# 要件定義書 再レビュー（`docs/requirements.md`）

作成日: 2026-01-02  
対象: `docs/requirements.md`

## 0. 変更確認メモ

- 作業ツリー上は `git diff -- docs/requirements.md` が空でした（未コミット差分なし）。
- 本レビューは **現時点でリポジトリにある最新版** を前提に再整理しています（前回レビュー内容は引き続き有効）。

## 1. 総評（MVPとしての強み）

- **コアバリュー（画像→型番→公式PDF→メンテ抽出）**が明確で、MVP（3画面）への落とし込みも分かりやすいです。
- Next.js + FastAPI + Supabase + Storage + Push の構成は、探索〜保存〜通知までの責務分離として妥当です。

## 2. “仕様として確定” しておくと詰まりにくいポイント（優先度高）

### 2.1 例外系（失敗時のフォールバック）を要件に明記

- 画像認識NG（メーカー不明 / 型番不明 / 候補が複数）の場合:
  - 手動入力への誘導、候補選択UI、再撮影ガイド（ラベル位置指示）のどれをMVPに入れるか
- 公式PDFが見つからない場合:
  - URL保存のみで止めるのか、手動アップロード必須にするのか、暫定的に「テキストメモ管理」にするのか
- PDFがスキャン画像でテキスト抽出できない場合:
  - OCR実行（有料化リスク）/ 手動入力 / “抽出できない”扱い のどれにするか

### 2.2 メンテ周期の表現と、DB（`interval_days`）へのマッピング

現状DB案は `interval_days` を前提にしていますが、説明書は以下の表現が多いです:

- 「○ヶ月ごと」「年1回」などカレンダー周期
- 「使用後」「○時間運転ごと」など使用量ベース
- 「シーズン前」「異常時」など条件ベース

MVPで割り切る案（例）:

- DBは `interval_days` を採用し、**変換できないものは“手動設定必須”**にする
- もしくは `interval_type`（days / months / condition / usage）を追加し、UIで扱いを分ける

### 2.3 通知仕様（最低限の決めごと）

- いつ通知するか: 例）`next_due_at` の **当日 9:00**、または前日/当日選択
- タイムゾーン: 例）ユーザー単位で `Asia/Tokyo` 固定、もしくはプロフィールに保持
- リトライ/上限: 例）期限超過は毎日1回、最大N回など

※ PWA Push は端末/ブラウザ制約があるため、MVPで「Pushが使えない環境」の扱い（表示だけ/メール代替/設定で案内）も要件に一文あると安全です。

## 3. データモデルの見直し提案（MVPを崩さず将来に効く）

### 3.1 マニュアルを独立テーブルにするか

現状は `appliances.manual_url` を想定していますが、以下が起きやすいです:

- 同一家電でも **複数マニュアル**（取説/施工説明/保証/部品表）
- PDFの版違い、言語違い、リンク切れ更新

MVPでも最低限:

- `manual_source_url`（出典URL）と `stored_pdf_path`（保存先）を分ける
- “temp→正式” 昇格のステータス（confirmed）を持つ

### 3.2 抽出結果に “根拠” を残す

- 抽出結果に `source_page`（ページ番号）や `quote`（該当文）を持てると、
  - ユーザー確認が速い
  - 手動修正の負担が下がる
  - AIの誤抽出が許容しやすくなる

## 4. 画面要件（3画面）を実装できる粒度にするための追記候補

- **ログイン画面**: パスワードリセット有無 / メール確認フロー（confirm）有無
- **家電一覧画面**:
  - 期限超過の扱い（最上位固定/色/バッジ）
  - 一覧から完了できるか（できるなら誤タップ防止）
- **家電登録画面**:
  - ステップ形式（認識→PDF→抽出→確認）にするか
  - “ユーザー確認”で修正できる項目（メーカー/型番/カテゴリ/抽出タスク/周期）

## 5. 非機能・運用（最低限の一文があると助かる）

- PDFサイズ上限、アップロード上限、処理タイムアウト
- 失敗時のログ（どの段で失敗したか）と、再試行導線
- コスト上限（検索・OCR・LLM）と、上限を超えそうな時の制限方針

## 6. コンプラ/出典（最低限の安全策）

- 公式PDFの取得・保存は利用規約の影響があるため、要件に以下のいずれかを明記推奨:
  - **出典URLの保存を必須**にする
  - 保存PDFの削除要請に応じられる運用方針
  - 必要なら「URLのみ管理」モードを用意

## 7. 次アクション（要件定義書に追記すると良いもの）

- 主要機能ごとに **Acceptance Criteria** を2〜3行ずつ追加
- “周期の変換ルール（or 手動必須）” を明文化
- Pushが不可の環境での扱い（案内/代替/未対応）を一文で固定
