# QA回答セルフチェック機能 実装プラン

**作成日**: 2026-01-12
**優先度**: 中（タスク8）
**工数目安**: 3〜4時間

---

## 概要

QA回答生成後にLLMで整合性を検証し、回答品質を向上させる機能を実装する。

## 背景

現在の3段階フォールバック（QA検索 → テキストキャッシュ → PDF直接分析）では、回答が質問の意図から外れる場合がある。セルフチェックを導入することで、回答の品質を担保する。

## 実装内容

### 1. セルフチェックプロンプトの作成

```python
SELF_CHECK_PROMPT = """
以下の質問と回答を評価してください：

【質問】
{question}

【回答】
{answer}

【評価基準】
1. 質問の意図を正しく理解しているか
2. 具体的で実用的な情報を提供しているか
3. 製品の取扱説明書に基づいた回答になっているか

【出力形式】
{{
  "score": 1-5の整数,
  "is_acceptable": true/false,
  "reason": "評価理由（日本語で簡潔に）",
  "improved_answer": "改善案（is_acceptableがfalseの場合のみ）"
}}
"""
```

### 2. qa_chat_service.py の修正

**修正箇所**: `QAChatService.generate_answer()` メソッド

**フロー**:
1. 既存の回答生成処理
2. セルフチェック呼び出し（新規追加）
3. スコアが閾値未満の場合:
   - `improved_answer` があれば採用
   - なければ「この回答は確認が必要かもしれません」マークを付与
4. レスポンスに `self_check_score` を追加（オプション）

### 3. 設定可能なパラメータ

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| `SELF_CHECK_ENABLED` | `True` | セルフチェック有効/無効 |
| `SELF_CHECK_THRESHOLD` | `3` | 許容スコア閾値（1-5） |
| `SELF_CHECK_MAX_RETRIES` | `1` | 再生成最大回数 |

### 4. コスト考慮

- セルフチェックで追加LLM呼び出し: 1回/質問
- 再生成が発生した場合: 最大+1回
- 合計: 通常2回、最大3回のLLM呼び出し

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|---------|
| `backend/app/services/qa_chat_service.py` | セルフチェックロジック追加 |
| `backend/app/schemas/qa.py` | レスポンスに `self_check_score` 追加（オプション） |

## テスト項目

1. セルフチェックが正常に動作すること
2. 低スコア時に改善回答が採用されること
3. 改善回答がない場合にマークが付与されること
4. `SELF_CHECK_ENABLED=False` で無効化できること

## 注意事項

- フロントエンド変更は不要（バックエンドのみの改修）
- SSEストリーミングの進捗表示にセルフチェックステップを追加可能（将来対応）
