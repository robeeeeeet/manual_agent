# 機能実装優先度リスト

**作成日**: 2026-01-12

---

## 質問への回答

### Q1: メンテナンスは削除じゃなくてアーカイブにできますか？

**はい、可能です。** 現在の `maintenance_schedules` テーブルには削除機能しかありませんが、以下の実装で対応できます：

1. **DBマイグレーション**: `is_archived` (BOOLEAN DEFAULT false) カラムを追加
2. **バックエンドAPI**: `PATCH /maintenance/{id}/archive` と `/unarchive` エンドポイント
3. **フロントエンドUI**: 家電詳細ページに折りたたみ式「アーカイブされた項目」セクション

**設計ポイント**:
- アーカイブは「論理削除」の一種で、データを残しつつ非表示にする設計パターン
- 将来「削除済みを含めた統計」が必要な場合にも対応しやすい
- RLSポリシーは既存のまま、WHERE句で `is_archived = false` を追加するだけ

---

### Q2: QAの回答精度を上げるにはどうしたらいい？

現在の3段階フォールバック（QA検索 → テキストキャッシュ → PDF直接分析）には以下の改善策があります：

| 方法 | 効果 | 実装コスト | 推奨度 |
|------|------|-----------|--------|
| **セルフチェック（回答検証）** | 中〜高 | 低 | ⭐⭐⭐ |
| プロンプト改善 | 中 | 低 | ⭐⭐⭐ |
| RAG（ベクトル検索）移行 | 高 | 高 | ⭐⭐ |
| メンテナンス項目個別LLM呼び出し | 中 | 中 | ⭐⭐ |

**「質問と回答の整合性をLLMに確認させる」は有効なアプローチです。** 実装例：

```python
# 回答生成後にセルフチェック
verification_prompt = """
以下の質問と回答を評価してください：
質問: {question}
回答: {answer}

この回答は質問に対して適切ですか？
- 質問の意図を正しく理解していますか？
- 具体的で実用的な情報を提供していますか？
- 製品の取扱説明書に基づいた回答になっていますか？

評価: [適切/不十分/要改善]
改善案があれば記載してください。
"""
```

**設計ポイント**:
- セルフチェックはLLM呼び出しが1回追加されるが、精度向上効果は高い
- 「Chain of Thought」の延長で、回答の自己評価を組み込む
- 低評価なら再生成 or 「この回答は確認が必要かもしれません」とマーク

---

## 優先度付きタスクリスト

### 🔴 優先度: 高（早期対応推奨）

| # | タスク | 難易度 | 工数目安 | 理由 |
|---|--------|--------|----------|------|
| 1 | **スマホ画面のUI/レイアウト全機能確認・修正** | 中 | 1〜2日 | ユーザー体験に直結、多くの利用者がスマホ |
| 2 | **QA回答のマークダウン表記修正** | 低 | 2〜4時間 | 現状のUXが悪い、SafeHtmlまたはraw textモード追加 |
| 3 | **家電詳細ページのQA自動スクロール削除** | 低 | 30分 | 簡単に修正可能、ユーザーの意図に反する動作 |
| 4 | **メンテナンス項目のアーカイブ機能** | 中 | 4〜6時間 | 削除は取り返しがつかない、より良いUX |
| 5 | **家電一覧に登録者表示** | 低 | 1〜2時間 | グループ機能を活かすための情報表示 |
| 6 | **ユーザーガイドにメンテナンス選択説明追加** | 低 | 30分 | ドキュメント追加のみ |

### 🟡 優先度: 中（将来対応）

| # | タスク | 難易度 | 工数目安 | 備考 |
|---|--------|--------|----------|------|
| 7 | **カスタムメンテナンス登録機能** | 中 | 4〜6時間 | 基盤は整っている（`user_appliance_id`カラム） |
| 8 | **QA精度向上（セルフチェック導入）** | 中 | 3〜4時間 | 回答後に整合性検証を追加 |
| 9 | **メンテナンス項目個別LLM呼び出し** | 中 | 4〜6時間 | 現在のバッチ抽出から変更、精度向上期待 |
| 10 | **Amazonアフィリエイトリンク機能** | 高 | 1〜2日 | LLM調査 + Amazon API連携 |
| 11 | **メーカー名名寄せ・マスタ化バッチ** | 中 | 4〜6時間 | LLMで類似判定、定期バッチ |

### 🟢 優先度: 低（余裕があれば）

| # | タスク | 難易度 | 工数目安 | 備考 |
|---|--------|--------|----------|------|
| 12 | **APIの自動テスト作成** | 中 | 1〜2日 | pytest + FastAPI TestClient |
| 13 | **E2Eテストのテスト項目作成** | 中 | 1日 | Playwright テストケース設計 |

---

## 作業内容まとめ

### 早めに対応したい機能（詳細）

#### 1. スマホ画面UI/レイアウト修正

- **作業内容**: 全ページをスマホ実機/エミュレータで確認し、崩れ・ダサいフォントを修正
- **確認対象**: ログイン、登録、家電一覧、家電詳細、メンテナンス一覧、グループ、マイページ、ヘルプ
- **ポイント**: Tailwindのレスポンシブクラス、フォントファミリー、余白調整

#### 2. QA回答のマークダウン表記修正

- **作業内容**: 回答がプレーンテキストで返るため、`** **` などがそのまま表示される問題を修正
- **選択肢**:
  - A) マークダウンとして解釈してHTML化（react-markdown導入）
  - B) LLMプロンプトを変更して「プレーンテキストで回答」と指示
- **推奨**: B（既存のSafeHtmlと競合せず、シンプル）

#### 3. QA自動スクロール削除

- **作業内容**: `/appliances/[id]` ページの `useEffect` からスクロール処理を削除
- **該当箇所**: `frontend/src/app/appliances/[id]/page.tsx`

#### 4. メンテナンスアーカイブ機能

- **DB変更**: `maintenance_schedules` に `is_archived BOOLEAN DEFAULT false` 追加
- **バックエンドAPI**: `PATCH /maintenance/{id}/archive`, `PATCH /maintenance/{id}/unarchive`
- **BFF層**: 同様のエンドポイント追加
- **フロントエンド**:
  - 家電詳細ページに「アーカイブされた項目」折りたたみセクション追加
  - アーカイブ/復元ボタンUI
  - メンテナンス一覧からはアーカイブ済みを除外

#### 5. 家電一覧に登録者表示

- **作業内容**: 家電一覧で「登録者: ○○さん」を表示
- **データ取得**: `user_appliances` → `users.display_name` をJOIN
- **UI**: 家電カードに小さく表示

#### 6. ユーザーガイド更新

- **作業内容**: `/help` ページに「メンテナンス項目は自動抽出後、必要なものを選択してください」という説明を追加

---

### 将来実装したい機能（詳細）

#### 7. カスタムメンテナンス登録機能

- **作業内容**: ユーザーが手動でメンテナンス項目を追加できる機能
- **DB**: `shared_maintenance_items.user_appliance_id` を使用（既存カラム）
- **UI**: 家電詳細ページに「メンテナンス項目を追加」ボタン

#### 8. QA精度向上（セルフチェック導入）

- **作業内容**: 回答生成後にLLMで整合性を検証
- **実装箇所**: `backend/app/services/qa_chat_service.py`
- **フロー**: 回答生成 → セルフチェック → 低評価なら再生成 or マーク付与

#### 9. メンテナンス項目個別LLM呼び出し

- **作業内容**: 現在のバッチ抽出を項目ごとの個別抽出に変更
- **メリット**: 各項目の精度向上、途中失敗時のリカバリが容易
- **デメリット**: API呼び出し回数増加、コスト増

#### 10. Amazonアフィリエイトリンク機能

- **作業内容**: メンテナンスに必要な付属品のAmazonリンクを表示
- **実装内容**:
  - LLMで必要な付属品を特定
  - Amazon Product Advertising API で商品検索
  - アフィリエイトリンク生成

#### 11. メーカー名名寄せ・マスタ化バッチ

- **作業内容**: 登録済み全家電のメーカー名を正規化
- **実装内容**:
  - 定期バッチ（Cloud Scheduler）
  - LLMで類似メーカー名を判定
  - `manufacturers` マスターテーブル作成
  - フロントエンドの検索をセレクトボックス + 自由入力に変更

#### 12. APIの自動テスト作成

- **作業内容**: バックエンドAPIのユニットテスト・統合テスト
- **ツール**: pytest, FastAPI TestClient
- **対象**: 全APIエンドポイント

#### 13. E2Eテストのテスト項目作成

- **作業内容**: Playwrightを使ったE2Eテストケース設計
- **対象フロー**: ログイン、家電登録、メンテナンス完了、グループ共有など
