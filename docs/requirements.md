# 説明書管理 & メンテナンスリマインドアプリ - 要件定義書

## 1. 概要

家電や住宅設備の説明書を管理し、説明書に記載されたメンテナンス項目をリマインドするWebアプリ。
将来的には家電に限らず、説明書が存在するすべての商品に対応予定。

### コアバリュー（このアプリの肝）
1. **AI画像認識**: 商品の写真からメーカー・型番を読み取り（または外観から商品を推測し、ラベル位置を指示）
2. **AI説明書取得**: メーカー名・型番から公式マニュアルPDFを自動取得
3. **AIメンテナンス抽出**: マニュアルを解析し、メンテナンス項目・周期を正確に抽出

### ターゲットユーザー
- 個人/家族（自宅の家電・設備を管理したい一般ユーザー）

### プラットフォーム
- Webアプリ（PWA対応でスマホからも利用可能）

---

## 2. MVP機能要件

### 2.1 説明書検索・登録機能

| 機能 | 詳細 |
|------|------|
| 画像からの商品特定 | 商品写真やラベルをアップロード → AIが型番・メーカーを認識 |
| 手動入力 | メーカー名・型番をテキストで入力 |
| 説明書PDF取得 | Web検索で公式説明書PDFを取得・保存 |
| 手動アップロード | ユーザーが自分でダウンロードしたPDFをアップロード |
| 保存先検索優先 | まず既存ストレージを検索 → なければWeb検索 |

**フロー**
```
【自動取得】画像/型番入力 → AI解析 → ストレージ検索 → (なければ)Web検索 → 一時保存 → ユーザー確認 → 正式保存
【手動】ユーザーがPDFアップロード → メタ情報入力 → 正式保存
```

### 2.2 リマインド機能

| 機能 | 詳細 |
|------|------|
| メンテナンス項目抽出 | AIが説明書から全メンテナンス項目と周期を自動抽出 |
| スケジュール登録 | 抽出された項目を確認後、スケジュールとして登録 |
| Push通知 | PWA Push通知でスマホに通知 |
| 完了記録 | 作業完了をタップで記録、次回リマインド自動設定 |

#### 周期マッピングルール

| 説明書の表現 | interval_type | interval_value | 備考 |
|-------------|---------------|----------------|------|
| 「月1回」「3ヶ月ごと」 | months | 1, 3 | カレンダー周期 |
| 「年1回」 | months | 12 | 年周期 |
| 「毎週」「2週間ごと」 | days | 7, 14 | 日数周期 |
| 「使用後」「異常時」 | manual | - | 手動設定必須 |
| 「シーズン前」 | manual | - | ユーザーが日付指定 |

### 2.3 ユーザー管理

| 機能 | 詳細 |
|------|------|
| メール+パスワード認証 | Supabase Authで実装 |
| 個人利用のみ | MVPは個人利用のみ対応（家族共有は将来拡張） |
| マイページ | メンテナンス統計表示、通知設定、通知時刻変更、ログアウト |

#### マイページ機能

| 機能 | 詳細 |
|------|------|
| メンテナンス統計 | 今週予定、超過件数、今月完了、累計完了の4項目表示 |
| 通知設定 | Push通知の有効化/無効化（許可ユーザーはテスト通知送信可能） |
| 通知時刻変更 | 1時間単位のセレクト（00:00〜23:00） |
| ログアウト | サインアウトボタン |

### 2.4 例外処理・フォールバック

| シナリオ | 対応 |
|---------|------|
| 画像認識失敗（メーカー/型番不明） | 手動入力フォームへ誘導 |
| 画像認識で複数候補 | 候補一覧から選択 or 手動入力 |
| PDF取得失敗（見つからない） | 手動アップロードへ誘導 |
| PDFテキスト抽出不可 | 「抽出不可」表示 + 手動入力 |
| メンテナンス項目抽出失敗 | 「抽出できませんでした」+ 手動追加 |

### 2.5 通知仕様

| 項目 | 仕様 |
|------|------|
| 通知タイミング | ユーザー設定可能（デフォルト: 当日 9:00） |
| タイムゾーン | Asia/Tokyo 固定（MVP） |
| 期限超過時 | 毎日1回通知（最大7日間） |
| PWA非対応環境 | 一覧画面での表示のみ（メール通知は将来拡張） |

---

## 3. 将来的な拡張

- [ ] **家電詳細画面 + AIエージェント質問機能**（マニュアルを元に回答）
- [ ] **家電以外の商品対応**（車、自転車、家具、工具など説明書がある商品全般）
- [ ] 家族グループ共有機能
- [ ] LINE通知対応
- [ ] カテゴリ別RAGで質問対応・買い替え相談
- [ ] 動画アップロードによるトラブル対応
- [ ] 付属品購入リンク（Amazonアフィリエイト連携）
- [ ] 商品ごとのQAドキュメント自動生成

---

## 4. 技術スタック

### アーキテクチャ概要

**ハイブリッド構成**: Next.js（フロントエンド）+ Python（AIバックエンド）

```
クライアント（ブラウザ/PWA）
        ↓
Next.js 16+ (TypeScript) - UI/BFF層
        ↓ REST API
FastAPI (Python) - AIバックエンド
        ↓
Supabase (PostgreSQL/Auth/Storage)
```

### フロントエンド
- **Next.js 16+** (App Router)
- **TypeScript**
- **Tailwind CSS**
- **PWA対応**（Phase 5で実装予定）

### BFF層（Backend for Frontend）
- **Next.js API Routes**
  - 認証確認
  - Python バックエンドへのプロキシ
  - レスポンス整形

### AIバックエンド
- **FastAPI** (Python)
- **Gemini API** (`google-genai` を直接利用)
  - 画像認識（型番・メーカー特定）
  - 説明書解析（メンテナンス項目・周期の抽出）
  - RAG（マニュアル検索・質問応答）

### データベース/認証
- **Supabase**
  - PostgreSQL（メインDB）
  - pgvector（RAG用ベクトル検索）
  - Auth（メール認証）

### ストレージ
- **Supabase Storage** または **Google Cloud Storage**
  - `manuals` バケット: 共有PDF保存（非公開 + 署名付きURL）
  - パス: `{manufacturer}/{model_number}.pdf`

### 通知
- **Web Push API** (VAPID)
- Service Workerでバックグラウンド通知

### 採用理由

| 選択 | 理由 |
|------|------|
| Python バックエンド | Gemini API（`google-genai`）をサーバー側で安全に利用可能 |
| Next.js フロントエンド | モダンなUI/UX、SSR、PWA対応 |
| Supabase | 認証・DB・ストレージを一元管理、pgvector対応 |

---

## 5. データモデル

```
users
├── id, email, created_at
├── notify_time          # 通知時刻（デフォルト 09:00）
├── timezone             # タイムゾーン（デフォルト Asia/Tokyo）

shared_appliances (家電マスター)
├── id, maker, model_number, category
├── manual_source_url
├── stored_pdf_path      # Supabase Storage のパス（共有）

user_appliances (所有関係)
├── id, user_id, shared_appliance_id
├── name                 # 表示名
├── image_url

maintenance_schedules (メンテナンス予定)
├── id, user_appliance_id, task_name
├── interval_type        # days / months / manual
├── interval_value       # 数値（manualの場合はnull）
├── last_done_at, next_due_at
├── source_page          # 根拠ページ番号

shared_maintenance_items (共有キャッシュ)
├── id, shared_appliance_id, task_name
├── recommended_interval_type / value
├── extracted_at

maintenance_logs (実施記録)
├── id, schedule_id, done_at, done_by_user_id

push_subscriptions (通知設定)
├── id, user_id, endpoint, keys

# 将来拡張（家族共有機能）
# families (グループ)
# ├── id, name, owner_id, invite_code
# family_members
# ├── family_id, user_id, role
```

---

## 6. 画面構成

### MVP（3画面）

1. **ログイン画面**
   - メール + パスワード認証
   - 新規登録
   - メール確認フロー（OTPコード方式：PWA対応のためリンク方式から変更）
   - ※パスワードリセットはMVP対象外

2. **家電一覧画面**
   - 次回作業実施日の近い順に表示
   - **期限超過は最上位固定 + 赤色表示**
   - 各アイテムに次回メンテナンス日・内容を表示
   - Push通知設定へのリンク
   - **通知時刻の設定**

3. **家電登録画面**（ステップ形式）
   - Step 1: 画像アップロード or 手動入力
   - Step 2: AI解析結果の確認・修正（メーカー/型番/カテゴリ）
   - Step 3: 説明書検索・取得 or 手動アップロード
   - Step 4: メンテナンス項目の確認・編集
   - Step 5: 登録完了

### 将来的に追加

4. **家電詳細画面**
   - タップで一覧から遷移
   - 説明書PDF表示
   - メンテナンス履歴
   - **AIエージェントに質問**（マニュアルを元に回答）

5. **家族管理画面**
   - メンバー招待
   - 招待コード入力

---

## 7. 外部連携

| サービス | 用途 | 無料枠 |
|----------|------|--------|
| Supabase | DB/認証 | 500MB DB, 50K MAU |
| Google Cloud Storage | PDF保存 | 5GB/月 |
| Gemini API | 画像解析 | 60 QPM (無料) |
| Web Push | 通知 | 無料 |

---

## 8. 確定事項

- [x] **説明書の取得方法**: PDFダウンロード保存 + ユーザー手動アップロードの両対応
- [x] **カテゴリ**: 事前定義リスト + 「その他」で自由入力可能

### カテゴリ初期リスト

| カテゴリ | 例 |
|----------|-----|
| エアコン・空調 | エアコン、空気清浄機、除湿機 |
| 洗濯・乾燥 | 洗濯機、乾燥機 |
| キッチン | 冷蔵庫、電子レンジ、食洗機、炊飯器 |
| 給湯・暖房 | 給湯器、床暖房、ストーブ |
| 掃除 | 掃除機、ロボット掃除機 |
| 住宅設備 | 換気扇、24時間換気、インターホン |
| その他 | 自由入力 |

---

## 9. MVPスコープ

### MVPに含む機能
- [x] 個人利用（認証・登録）
- [x] 画像認識 → 手動入力フォールバック
- [x] PDF取得（検索→確認→保存）→ 手動入力フォールバック
- [x] メンテナンス抽出（共有キャッシュ）→ 手動追加可能
- [ ] PWA Push通知（ユーザー設定可能な時刻）※ Phase 5
- [ ] 完了記録・次回自動設定 ※ Phase 4

### MVPに含まない機能
- [ ] 家族グループ共有
- [ ] 家電詳細画面・RAG質問機能
- [ ] LINE通知
- [ ] パスワードリセット
- [ ] OCR再学習

---

## 10. 非機能要件

| 項目 | 仕様 |
|------|------|
| PDFサイズ上限 | 50MB |
| 画像サイズ上限 | 10MB |
| 処理タイムアウト | 60秒 |
| 同時登録制限 | 1件ずつ（MVP） |
| PDF保存時の出典URL | 必須 |
| 同時検索制限 | 5件（サーバー全体で並行検索を制限） |

---

## 11. 実装上の仕様（要件定義書に未記載の詳細）

以下は開発中に追加された実装仕様です。要件定義の変更ではなく、実装上の詳細設計として記録します。

### 11.1 説明書検索の詳細仕様

#### ストリーミング検索（SSE）
- 検索の進捗状況をリアルタイムでフロントエンドに送信
- Server-Sent Events (SSE) を使用
- 進捗ステップ: `init`, `domain`, `google_search`, `check_result`, `verify_pdf`, `page_search`, `llm_extract`, `deep_search` 等

#### 再検索機能
ユーザーが検索結果に満足しなかった場合の再検索をサポート：

| パラメータ | 説明 |
|-----------|------|
| `excluded_urls` | 前回の検索結果から除外するURL一覧 |
| `skip_domain_filter` | ドメインフィルターを無効化し、より広範囲に検索 |
| `cached_candidates` | 前回の検索で見つかった候補を再利用 |

#### 候補キャッシュ
- 検索中に見つかったPDF候補を全て記録
- 再検索時に未検証の候補から優先的に検証
- 優先度（priority）による検証順序の制御

#### メーカードメイン学習
- PDFが見つかったドメインを `manufacturer_domains` テーブルに記録
- 同じメーカーの次回検索時に、学習済みドメインを優先的に検索
- `success_count` で成功回数を追跡し、信頼性の高いドメインを優先

#### スニペット判定ロジック
検索結果のスニペットから対象マニュアルかどうかを3段階で判定：

| 判定 | 条件 | 処理 |
|------|------|------|
| `yes` | URLに型番が含まれ、マニュアルキーワードあり | HTTPアクセスのみで検証 |
| `maybe` | 型番またはマニュアルキーワードのいずれか | LLMでPDF内容を検証 |
| `no` | どちらも含まれない | スキップ |

### 11.2 データベース設計の追加仕様

#### 共有マスター方式
- `shared_appliances`: 家電マスターデータ（メーカー・型番・説明書情報）
- `user_appliances`: ユーザーの所有関係（表示名・画像）
- 同一メーカー・型番の家電は1レコードで管理し、複数ユーザーで共有

#### メンテナンス項目キャッシュ
- `shared_maintenance_items`: LLM抽出結果のキャッシュ
- 同じ家電のメンテナンス項目は一度だけ抽出
- 2人目以降のユーザーは即座に項目取得可能（LLMコスト削減）

詳細は `backend/supabase/SCHEMA.md` を参照。

### 11.3 並行処理制限

| 設定 | デフォルト値 | 説明 |
|------|------------|------|
| `max_concurrent_searches` | 5 | 同時に実行可能な説明書検索の最大数 |
| `max_thread_pool_workers` | 10 | ブロッキングI/O操作用のスレッドプールサイズ |

検索リクエストが上限に達した場合、新しいリクエストは待機状態になり、スロットが空き次第処理されます。
